/** =========================
 *  CONFIG
 *  ========================= */
const SPREADSHEET_ID  = "1AVU8dHTMSMuwmIdx4uV8MuEc-8S9B67MhK6ViuHPFf4";

const SHEET_EMPLOYEE  = "Employee";
const SHEET_MAGENTO   = "Magento";
const SHEET_ORDERS    = "Order";
const SUPPLIER_PREFIX = "Supplier_";
const ADMIN_KEY       = "SC76";

// ✅ Zet hier jouw email (vaste ontvanger)
const LEAD_NOTIFY_EMAIL = "PLAK_HIER_JOUW_EMAIL@DOMAIN.COM";

/** =========================
 *  WEB APP ENTRYPOINT
 * ========================= */
function doGet(e) {
  try {
    e = e || { parameter: {} };
    e.parameter = e.parameter || {};

    const action   = String(e.parameter.action || "data").trim();
    const key      = String(e.parameter.key || "").trim();
    const callback = String(e.parameter.callback || "").trim();

    let result;
    if (action === "ping") result = ping_();
    else if (action === "data") result = getPortalDataForKey_(key);
    else if (action === "orders") result = getOrdersForKey_(key);           // ✅ admin-only
    else if (action === "submitLead") result = submitLead_(key, e.parameter);
    else result = { ok: false, error: "Unknown action: " + action };

    return output_(result, callback);
  } catch (err) {
    const cb = (e && e.parameter && e.parameter.callback) ? String(e.parameter.callback).trim() : "";
    return output_({ ok: false, error: String(err && err.message ? err.message : err) }, cb);
  }
}

function ping_() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  return { ok: true, sheets: ss.getSheets().map(s => s.getName()) };
}

/** =========================
 *  AUTH
 * ========================= */
function getUserByKey_(ss, key) {
  const sh = ss.getSheetByName(SHEET_EMPLOYEE);
  if (!sh) throw new Error(`Missing sheet: ${SHEET_EMPLOYEE}`);

  const data = sh.getDataRange().getValues();
  if (data.length < 2) return null;

  const headers = normalizeHeaders_(data[0]);
  const keyCol  = headers.indexOf("EMPLOYEE KEY");
  const nameCol = headers.indexOf("EMPLOYEE");
  const roleCol = headers.indexOf("ROLE"); // optional

  if (keyCol === -1) throw new Error('Employee sheet must have header "Employee KEY"');

  for (let i = 1; i < data.length; i++) {
    const rowKey = safeText_(data[i][keyCol]).trim();
    if (rowKey === key) {
      return {
        name: nameCol >= 0 ? safeText_(data[i][nameCol]).trim() : "",
        role: roleCol >= 0 ? safeText_(data[i][roleCol]).trim() : "",
        row: data[i],
        headers
      };
    }
  }
  return null;
}

function isAdmin_(key, user) {
  return (key === ADMIN_KEY) || (String(user.role || "").toUpperCase() === "ADMIN");
}

/** =========================
 *  PRODUCTS ENDPOINT
 *  - dedupe by EAN, latest year wins
 * ========================= */
function getPortalDataForKey_(key) {
  if (!key) return { ok: false, error: "Missing key" };

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const user = getUserByKey_(ss, key);
  if (!user) return { ok: false, error: "Invalid key" };

  const admin = isAdmin_(key, user);
  const magentoMap = buildMagentoStockMap_(ss);
  const supplierSheets = getVisibleSupplierSheetNames_(ss, user, admin);

  const bestByEan = {};

  supplierSheets.forEach(sheetName => {
    const sh = ss.getSheetByName(sheetName);
    if (!sh) return;

    const sheetYear = extractYearFromSheetName_(sheetName);
    const data = sh.getDataRange().getValues();
    if (data.length < 2) return;

    const headers = normalizeHeaders_(data[0]);
    const idx = headerIndex_(headers, {
      ean: "EAN",
      product: "Product",
      purchase: "Purchase price",
      retail: "Retail price"
    });

    for (let r = 1; r < data.length; r++) {
      const row = data[r];
      const ean = safeText_(row[idx.ean]).trim();
      if (!ean) continue;

      const stock = magentoMap[ean] || { surfcenterStock: "", dropshipmentStock: "" };

      const candidate = {
        product: safeText_(row[idx.product]).trim(),
        retailPrice: row[idx.retail],
        purchasePrice: row[idx.purchase],
        ean,
        surfcenterStock: stock.surfcenterStock,
        dropshipmentStock: stock.dropshipmentStock,
        supplier: sheetName,
        supplierYear: sheetYear
      };

      const existing = bestByEan[ean];
      if (!existing) { bestByEan[ean] = candidate; continue; }

      const cy = candidate.supplierYear || 0;
      const ey = existing.supplierYear || 0;
      if (cy > ey) bestByEan[ean] = candidate;
      else if (cy === ey) {
        const candHas = candidate.purchasePrice !== "" && candidate.purchasePrice != null;
        const exHas = existing.purchasePrice !== "" && existing.purchasePrice != null;
        if (candHas && !exHas) bestByEan[ean] = candidate;
      }
    }
  });

  const rows = Object.keys(bestByEan).map(ean => bestByEan[ean]);
  rows.sort((a, b) => String(a.product || "").localeCompare(String(b.product || "")));

  return {
    ok: true,
    user: { name: user.name || "", role: admin ? "ADMIN" : (user.role || "EMPLOYEE") },
    isAdmin: admin,
    rows
  };
}

/** =========================
 *  ORDERS (LEADS) ENDPOINT — ✅ ADMIN ONLY
 * ========================= */
function getOrdersForKey_(key) {
  if (!key) return { ok: false, error: "Missing key" };

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const user = getUserByKey_(ss, key);
  if (!user) return { ok: false, error: "Invalid key" };

  const admin = isAdmin_(key, user);
  if (!admin) {
    // ✅ hard-enforced: employees see nothing
    return { ok: true, admin: false, orders: [] };
  }

  const sh = ss.getSheetByName(SHEET_ORDERS);
  if (!sh) throw new Error(`Missing sheet: ${SHEET_ORDERS}`);

  const data = sh.getDataRange().getValues();
  if (data.length < 2) return { ok: true, admin: true, orders: [] };

  const headers = normalizeHeaders_(data[0]);
  const col = (name) => headers.indexOf(String(name).toUpperCase());

  const cEmployee = col("Employee");
  const cEAN      = col("EAN");
  const cProduct  = col("Product");
  const cRetail   = col("Retail price");
  const cName     = col("Name");
  const cC1       = col("Contact 1");
  const cC2       = col("Contact 2");
  const cNote     = col("Note");
  const cSale     = col("Sale");

  if (cEmployee === -1 || cEAN === -1 || cProduct === -1 || cRetail === -1) {
    throw new Error('Order sheet must have headers: Employee, EAN, Product, Retail price');
  }

  const out = [];
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    out.push({
      employee: safeText_(row[cEmployee]).trim(),
      ean: safeText_(row[cEAN]).trim(),
      product: safeText_(row[cProduct]).trim(),
      retailPrice: row[cRetail],
      customerName: cName >= 0 ? safeText_(row[cName]).trim() : "",
      contact1: cC1 >= 0 ? safeText_(row[cC1]).trim() : "",
      contact2: cC2 >= 0 ? safeText_(row[cC2]).trim() : "",
      note: cNote >= 0 ? safeText_(row[cNote]).trim() : "",
      sale: cSale >= 0 ? safeText_(row[cSale]).trim() : ""
    });
  }

  return { ok: true, admin: true, orders: out };
}

/** =========================
 *  SUBMIT LEAD (append + email)
 * ========================= */
function submitLead_(key, params) {
  if (!key) return { ok: false, error: "Missing key" };

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const user = getUserByKey_(ss, key);
  if (!user) return { ok: false, error: "Invalid key" };

  const payloadRaw = String(params.payload || "");
  if (!payloadRaw) return { ok: false, error: "Missing payload" };

  let payload;
  try { payload = JSON.parse(payloadRaw); }
  catch (e) { return { ok: false, error: "Invalid payload JSON" }; }

  const customerName = safeText_(payload.customerName).trim();
  const contact1 = safeText_(payload.contact1).trim();
  const contact2 = safeText_(payload.contact2).trim();
  const note = safeText_(payload.note).trim();
  const items = Array.isArray(payload.items) ? payload.items : [];

  if (!customerName) return { ok: false, error: "Naam is verplicht" };
  if (!contact1 && !contact2) return { ok: false, error: "Minimaal 1 contactveld is verplicht" };
  if (!items.length) return { ok: false, error: "Winkelmandje is leeg" };

  const sh = ss.getSheetByName(SHEET_ORDERS);
  if (!sh) throw new Error(`Missing sheet: ${SHEET_ORDERS}`);

  ensureOrderHeaders_(sh);

  const employeeName = user.name || "Employee";
  const rowsToAppend = items.map(it => ([
    employeeName,
    safeText_(it.ean).trim(),
    safeText_(it.product).trim(),
    it.retailPrice,
    customerName,
    contact1,
    contact2,
    note,
    "" // Sale
  ]));

  sh.getRange(sh.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length).setValues(rowsToAppend);

  // ✅ email zonder Session.getEffectiveUser()
  sendLeadEmail_(employeeName, customerName, contact1, contact2, note, items);

  return { ok: true, appended: rowsToAppend.length };
}

function ensureOrderHeaders_(sh) {
  const desired = ["Employee","EAN","Product","Retail price","Name","Contact 1","Contact 2","Note","Sale"];
  const lastRow = sh.getLastRow();
  if (lastRow === 0) {
    sh.getRange(1,1,1,desired.length).setValues([desired]);
    return;
  }
  const header = sh.getRange(1,1,1,Math.max(sh.getLastColumn(), desired.length)).getValues()[0];
  const norm = header.map(h => safeText_(h).trim());
  if (!norm.some(x => x)) sh.getRange(1,1,1,desired.length).setValues([desired]);
}

function sendLeadEmail_(employeeName, customerName, contact1, contact2, note, items) {
  const to = LEAD_NOTIFY_EMAIL;
  const subject = `Nieuwe lead van ${employeeName}`;

  const lines = [];
  lines.push(`${employeeName} heeft de volgende lead doorgegeven:`);
  lines.push("");
  lines.push("Producten:");
  items.forEach(it => {
    lines.push(`- ${safeText_(it.product).trim()} | EAN: ${safeText_(it.ean).trim()} | Retail: ${formatEuro_(it.retailPrice)}`);
  });
  lines.push("");
  lines.push("Voor klant:");
  lines.push(`Naam: ${customerName}`);
  lines.push(`Contact 1: ${contact1 || "-"}`);
  lines.push(`Contact 2: ${contact2 || "-"}`);
  lines.push(`Note: ${note || "-"}`);

  MailApp.sendEmail({ to, subject, body: lines.join("\n") });
}

function formatEuro_(v) {
  if (v === null || v === undefined || v === "") return "";
  const num = Number(String(v).replace(",", "."));
  return Number.isFinite(num) ? "€ " + num.toFixed(2) : String(v);
}

/** =========================
 *  Supplier visibility (base column covers years)
 * ========================= */
function getVisibleSupplierSheetNames_(ss, user, admin) {
  const allSheets = ss.getSheets().map(s => s.getName());
  const supplierSheets = allSheets.filter(n => n.startsWith(SUPPLIER_PREFIX));
  if (admin) return supplierSheets;

  const headers = user.headers;
  const row = user.row;

  return supplierSheets.filter(sheetName => {
    const upper = sheetName.toUpperCase();
    const base = baseSupplierName_(sheetName).toUpperCase();

    let col = headers.indexOf(upper);
    if (col >= 0) return safeText_(row[col]).trim().toUpperCase() === "YES";

    col = headers.indexOf(base);
    if (col >= 0) return safeText_(row[col]).trim().toUpperCase() === "YES";

    return false;
  });
}

function buildMagentoStockMap_(ss) {
  const sh = ss.getSheetByName(SHEET_MAGENTO);
  if (!sh) throw new Error(`Missing sheet: ${SHEET_MAGENTO}`);

  const data = sh.getDataRange().getValues();
  if (data.length < 2) return {};

  const headers = normalizeHeaders_(data[0]);
  const eanCol = headers.indexOf("EAN");
  const scCol  = headers.indexOf("SURFCENTER");
  const dsCol  = headers.indexOf("DROPSHIPMENT");
  if (eanCol === -1) throw new Error('Magento sheet must have header "EAN"');

  const map = {};
  for (let i = 1; i < data.length; i++) {
    const ean = safeText_(data[i][eanCol]).trim();
    if (!ean) continue;
    map[ean] = {
      surfcenterStock: scCol >= 0 ? data[i][scCol] : "",
      dropshipmentStock: dsCol >= 0 ? data[i][dsCol] : ""
    };
  }
  return map;
}

/** =========================
 *  Utils
 * ========================= */
function output_(obj, callback) {
  const payload = JSON.stringify(obj);
  if (callback) {
    return ContentService.createTextOutput(`${callback}(${payload});`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService.createTextOutput(payload)
    .setMimeType(ContentService.MimeType.JSON);
}

function normalizeHeaders_(headerRow) {
  return headerRow.map(h => safeText_(h).trim().toUpperCase());
}

function headerIndex_(headers, needed) {
  const idx = {};
  Object.keys(needed).forEach(k => {
    const i = headers.indexOf(String(needed[k]).toUpperCase());
    if (i === -1) throw new Error(`Missing header "${needed[k]}" in supplier sheet`);
    idx[k] = i;
  });
  return idx;
}

function safeText_(v) {
  if (v === null || v === undefined) return "";
  return String(v);
}

function extractYearFromSheetName_(sheetName) {
  const m = String(sheetName).match(/_(\d{4})$/);
  return m ? Number(m[1]) : 0;
}
function baseSupplierName_(sheetName) {
  return String(sheetName).replace(/_(\d{4})$/, "");
}
