<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales Portal</title>
  <style>
    :root { --border:#e5e5e5; --muted:#666; --bg:#fff; --soft:#fafafa; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #fcfcfc; color:#111; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .card { background: var(--bg); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    h1,h2 { margin:0; }
    h2 { font-size: 18px; }
    .muted { color: var(--muted); font-size: 14px; }
    .error { color:#b00020; margin-top: 10px; }
    input { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; min-width: 240px; font-size: 14px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-size: 14px; }
    button:hover { background: #f7f7f7; }
    .pill { display:inline-block; padding: 3px 10px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .spacer { height: 14px; }

    table { width: 100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; vertical-align: top; }
    th { font-size: 13px; color: #444; }
    .plus { width: 34px; text-align: center; }
    .plus button { width: 30px; height: 30px; border-radius: 10px; padding:0; }
    .details { background: var(--soft); }

    /* Views */
    .view { display:none; }
    .view.active { display:block; }

    /* Login layout */
    .loginShell { min-height: calc(100vh - 48px); display:flex; align-items:center; }
    .loginCard { max-width: 520px; margin: 0 auto; }
    .brand { font-size: 22px; letter-spacing: .2px; }
    .hint { margin-top: 6px; }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- LOGIN VIEW -->
    <div id="loginView" class="view active">
      <div class="loginShell">
        <div class="card loginCard">
          <div class="brand"><strong>Sales Portal</strong></div>
          <div class="muted hint">Log in met je Employee KEY.</div>

          <div class="spacer"></div>

          <div class="row">
            <input id="loginKey" placeholder="Employee KEY" autocomplete="off" />
            <button id="loginBtn">Inloggen</button>
          </div>

          <div id="loginError" class="error"></div>

          <div class="spacer"></div>
          <div class="muted">
            Tip: admin key is <span class="pill">SC76</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PORTAL VIEW -->
    <div id="portalView" class="view">
      <div class="card">
        <div class="topbar">
          <div>
            <h2>Sales Portal</h2>
            <div id="userLine" class="muted"></div>
          </div>
          <div class="row">
            <button id="logoutBtn">Logout</button>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="row">
          <input id="searchInput" placeholder="Zoek op product of EAN…" style="min-width:320px;" />
          <span id="meta" class="muted"></span>
        </div>

        <div id="portalError" class="error"></div>

        <table id="table">
          <thead>
            <tr>
              <th class="plus"></th>
              <th>Product</th>
              <th>Retail price</th>
              <th>Surfcenter Stock</th>
              <th>Dropshipment Stock</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr>
              <td class="plus"></td>
              <td class="muted" colspan="4">Data laden…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    /** 1) Zet hier jouw Apps Script Web App URL (moet eindigen op /exec) **/
    const APPS_SCRIPT_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz1Gvft0lM5SnOYpdm-O6YDvGwk4orJcKDlp0OTv127q_S3GFw0kEyw42lP8cE2uqQj/exec";

    /** State **/
    let allRows = [];
    let expanded = new Set();
    let currentKey = localStorage.getItem("employeeKey") || "";

    /** Elements **/
    const loginView   = document.getElementById("loginView");
    const portalView  = document.getElementById("portalView");

    const loginKey    = document.getElementById("loginKey");
    const loginBtn    = document.getElementById("loginBtn");
    const loginError  = document.getElementById("loginError");

    const logoutBtn   = document.getElementById("logoutBtn");
    const userLine    = document.getElementById("userLine");
    const searchInput = document.getElementById("searchInput");
    const meta        = document.getElementById("meta");
    const portalError = document.getElementById("portalError");
    const tbody       = document.getElementById("tbody");

    /** View helpers **/
    function showLogin(msg) {
      portalError.textContent = "";
      loginError.textContent = msg || "";
      loginView.classList.add("active");
      portalView.classList.remove("active");
      loginKey.value = "";
      loginKey.focus();
    }

    function showPortal() {
      loginError.textContent = "";
      loginView.classList.remove("active");
      portalView.classList.add("active");
      searchInput.value = "";
      searchInput.focus();
    }

    /** Formatting **/
    function fmtPrice(v) {
      if (v === null || v === undefined || v === "") return "";
      const num = Number(String(v).replace(",", "."));
      if (Number.isFinite(num)) return "€ " + num.toFixed(2);
      return String(v);
    }
    function fmtVal(v) {
      if (v === null || v === undefined) return "";
      return String(v);
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    /** JSONP **/
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement("script");
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error("Timeout while loading data"));
        }, 15000);

        window[cb] = (data) => { cleanup(); resolve(data); };

        function cleanup() {
          clearTimeout(timeout);
          delete window[cb];
          script.remove();
        }

        script.onerror = () => { cleanup(); reject(new Error("Failed to load script")); };

        const sep = url.includes("?") ? "&" : "?";
        script.src = url + sep + "callback=" + encodeURIComponent(cb);
        document.body.appendChild(script);
      });
    }

    /** Data loading **/
    async function loadDataForKey(key) {
      portalError.textContent = "";
      meta.textContent = "Laden…";
      tbody.innerHTML = `
        <tr>
          <td class="plus"></td>
          <td class="muted" colspan="4">Data laden…</td>
        </tr>`;

      if (!APPS_SCRIPT_WEBAPP_URL || APPS_SCRIPT_WEBAPP_URL.includes("PASTE_YOUR")) {
        meta.textContent = "";
        throw new Error("APPS_SCRIPT_WEBAPP_URL is niet ingevuld (moet eindigen op /exec).");
      }

      const url = `${APPS_SCRIPT_WEBAPP_URL}?action=data&key=${encodeURIComponent(key)}`;
      const res = await jsonp(url);

      if (!res || !res.ok) {
        throw new Error(res?.error || "Kon data niet laden.");
      }

      allRows = res.rows || [];
      expanded.clear();

      userLine.innerHTML =
        `Ingelogd: <strong>${escapeHtml(res.user?.name || "Medewerker")}</strong> ` +
        `<span class="pill">${escapeHtml(res.user?.role || "EMPLOYEE")}</span>`;

      meta.textContent = `${allRows.length} items • Tabs: ${(res.supplierSheets || []).length}`;

      render();
    }

    /** Rendering **/
    function render() {
      const q = searchInput.value.trim().toLowerCase();
      const rows = !q ? allRows : allRows.filter(r => {
        const product = (r.product || "").toLowerCase();
        const ean = (r.ean || "").toLowerCase();
        return product.includes(q) || ean.includes(q);
      });

      tbody.innerHTML = "";

      if (!rows.length) {
        tbody.innerHTML = `
          <tr>
            <td class="plus"></td>
            <td class="muted" colspan="4">Geen resultaten.</td>
          </tr>`;
        return;
      }

      rows.forEach((r, i) => {
        const id = `${r.ean}__${i}`;

        // main row
        const tr = document.createElement("tr");

        const tdPlus = document.createElement("td");
        tdPlus.className = "plus";
        const btn = document.createElement("button");
        btn.textContent = expanded.has(id) ? "−" : "+";
        btn.addEventListener("click", () => {
          if (expanded.has(id)) expanded.delete(id);
          else expanded.add(id);
          render();
        });
        tdPlus.appendChild(btn);

        tr.appendChild(tdPlus);
        tr.appendChild(tdText(r.product));
        tr.appendChild(tdText(fmtPrice(r.retailPrice)));
        tr.appendChild(tdText(fmtVal(r.surfcenterStock)));
        tr.appendChild(tdText(fmtVal(r.dropshipmentStock)));

        tbody.appendChild(tr);

        // details row
        if (expanded.has(id)) {
          const tr2 = document.createElement("tr");
          tr2.className = "details";
          const td = document.createElement("td");
          td.colSpan = 5;
          td.innerHTML = `
            <div class="row" style="justify-content:space-between;">
              <div><strong>EAN:</strong> ${escapeHtml(fmtVal(r.ean))}</div>
              <div><strong>Purchase price:</strong> ${escapeHtml(fmtPrice(r.purchasePrice))}</div>
            </div>
          `;
          tr2.appendChild(td);
          tbody.appendChild(tr2);
        }
      });
    }

    function tdText(text) {
      const td = document.createElement("td");
      td.textContent = (text ?? "");
      return td;
    }

    /** Events **/
    loginBtn.addEventListener("click", async () => {
      const key = loginKey.value.trim();
      if (!key) return (loginError.textContent = "Vul een Employee KEY in.");

      try {
        // show portal first (gives immediate feedback), then load
        currentKey = key;
        localStorage.setItem("employeeKey", currentKey);
        showPortal();
        await loadDataForKey(currentKey);
      } catch (err) {
        // rollback on login failure
        localStorage.removeItem("employeeKey");
        currentKey = "";
        showLogin("Inloggen mislukt: " + err.message);
      }
    });

    loginKey.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loginBtn.click();
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("employeeKey");
      currentKey = "";
      allRows = [];
      expanded.clear();
      meta.textContent = "";
      showLogin("");
    });

    searchInput.addEventListener("input", render);

    /** Boot **/
    (async function init() {
      if (currentKey) {
        try {
          showPortal();
          await loadDataForKey(currentKey);
        } catch (err) {
          localStorage.removeItem("employeeKey");
          currentKey = "";
          showLogin("Sessie verlopen / data laden mislukt: " + err.message);
        }
      } else {
        showLogin("");
      }
    })();
  </script>
</body>
</html>
