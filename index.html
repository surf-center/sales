/** =========================
 *  CONFIG
 *  ========================= */
const SPREADSHEET_ID = "1AVU8dHTMSMuwmIdx4uV8MuEc-8S9B67MhK6ViuHPFf4";

const SHEET_EMPLOYEE = "Employee";
const SHEET_MAGENTO  = "Magento";
const SUPPLIER_PREFIX = "Supplier_";
const ADMIN_KEY = "SC76";

/** =========================
 *  WEB APP ENTRYPOINT
 *  ========================= */
function doGet(e) {
  try {
    e = e || { parameter: {} };
    e.parameter = e.parameter || {};

    const action = String(e.parameter.action || "data").trim();
    const key = String(e.parameter.key || "").trim();
    const callback = String(e.parameter.callback || "").trim();

    let result;
    if (action === "ping") result = ping_();
    else if (action === "data") result = getPortalDataForKey_(key);
    else result = { ok: false, error: "Unknown action: " + action };

    return output_(result, callback);
  } catch (err) {
    const cb = (e && e.parameter && e.parameter.callback) ? String(e.parameter.callback).trim() : "";
    return output_({ ok: false, error: String(err && err.message ? err.message : err) }, cb);
  }
}

function ping_() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  return { ok: true, spreadsheetId: SPREADSHEET_ID, sheets: ss.getSheets().map(s => s.getName()) };
}

/** =========================
 *  MAIN
 *  ========================= */
function getPortalDataForKey_(key) {
  if (!key) return { ok: false, error: "Missing key" };

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);

  const user = getUserByKey_(ss, key);
  if (!user) return { ok: false, error: "Invalid key" };

  const isAdmin = (key === ADMIN_KEY) || (String(user.role || "").toUpperCase() === "ADMIN");

  const magentoMap = buildMagentoStockMap_(ss);
  const supplierSheets = getVisibleSupplierSheetNames_(ss, user, isAdmin);

  // Deduplicate by EAN: keep most recent year
  const bestByEan = {}; // ean -> best row

  supplierSheets.forEach(sheetName => {
    const sh = ss.getSheetByName(sheetName);
    if (!sh) return;

    const sheetYear = extractYearFromSheetName_(sheetName); // 2025 or 0
    const data = sh.getDataRange().getValues();
    if (data.length < 2) return;

    const headers = normalizeHeaders_(data[0]);
    const idx = headerIndex_(headers, {
      ean: "EAN",
      product: "Product",
      purchase: "Purchase price",
      retail: "Retail price"
    });

    for (let r = 1; r < data.length; r++) {
      const row = data[r];

      const ean = safeText_(row[idx.ean]).trim();
      if (!ean) continue; // dedupe key

      const product = safeText_(row[idx.product]).trim();
      const purchasePrice = row[idx.purchase];
      const retailPrice = row[idx.retail];

      const stock = magentoMap[ean] || { surfcenterStock: "", dropshipmentStock: "" };

      const candidate = {
        product,
        retailPrice,
        surfcenterStock: stock.surfcenterStock,
        dropshipmentStock: stock.dropshipmentStock,

        ean,
        purchasePrice,

        supplier: sheetName,
        supplierYear: sheetYear
      };

      const existing = bestByEan[ean];
      if (!existing) {
        bestByEan[ean] = candidate;
        continue;
      }

      const cy = candidate.supplierYear || 0;
      const ey = existing.supplierYear || 0;

      // Most recent year wins
      if (cy > ey) {
        bestByEan[ean] = candidate;
      } else if (cy === ey) {
        // Tie-break: prefer row with purchase price (optional)
        const candHas = candidate.purchasePrice !== "" && candidate.purchasePrice != null;
        const exHas = existing.purchasePrice !== "" && existing.purchasePrice != null;
        if (candHas && !exHas) bestByEan[ean] = candidate;
      }
    }
  });

  const rows = Object.keys(bestByEan).map(ean => bestByEan[ean]);
  rows.sort((a, b) => String(a.product || "").localeCompare(String(b.product || "")));

  return {
    ok: true,
    user: { name: user.name || "", role: isAdmin ? "ADMIN" : (user.role || "EMPLOYEE") },
    supplierSheets,
    rows
  };
}

/** =========================
 *  AUTH / EMPLOYEE SHEET
 *  ========================= */
function getUserByKey_(ss, key) {
  const sh = ss.getSheetByName(SHEET_EMPLOYEE);
  if (!sh) throw new Error(`Missing sheet: ${SHEET_EMPLOYEE}`);

  const data = sh.getDataRange().getValues();
  if (data.length < 2) return null;

  const headers = normalizeHeaders_(data[0]);
  const keyCol  = headers.indexOf("EMPLOYEE KEY");
  const nameCol = headers.indexOf("EMPLOYEE");
  const roleCol = headers.indexOf("ROLE"); // optional

  if (keyCol === -1) throw new Error('Employee sheet must have header "Employee KEY"');

  for (let i = 1; i < data.length; i++) {
    const rowKey = safeText_(data[i][keyCol]).trim();
    if (rowKey === key) {
      return {
        name: nameCol >= 0 ? safeText_(data[i][nameCol]).trim() : "",
        role: roleCol >= 0 ? safeText_(data[i][roleCol]).trim() : "",
        row: data[i],
        headers
      };
    }
  }
  return null;
}

/** =========================
 *  MAGENTO STOCK MAP
 *  ========================= */
function buildMagentoStockMap_(ss) {
  const sh = ss.getSheetByName(SHEET_MAGENTO);
  if (!sh) throw new Error(`Missing sheet: ${SHEET_MAGENTO}`);

  const data = sh.getDataRange().getValues();
  if (data.length < 2) return {};

  const headers = normalizeHeaders_(data[0]);
  const eanCol = headers.indexOf("EAN");
  const scCol  = headers.indexOf("SURFCENTER");
  const dsCol  = headers.indexOf("DROPSHIPMENT");

  if (eanCol === -1) throw new Error('Magento sheet must have header "EAN"');

  const map = {};
  for (let i = 1; i < data.length; i++) {
    const ean = safeText_(data[i][eanCol]).trim();
    if (!ean) continue;

    map[ean] = {
      surfcenterStock: scCol >= 0 ? data[i][scCol] : "",
      dropshipmentStock: dsCol >= 0 ? data[i][dsCol] : ""
    };
  }
  return map;
}

/** =========================
 *  SUPPLIER VISIBILITY
 *  - Supports columns:
 *      Supplier_Severne = YES   (covers Supplier_Severne_2025 too)
 *    OR exact:
 *      Supplier_Severne_2025 = YES
 *  ========================= */
function getVisibleSupplierSheetNames_(ss, user, isAdmin) {
  const allSheets = ss.getSheets().map(s => s.getName());
  const supplierSheets = allSheets.filter(n => n.startsWith(SUPPLIER_PREFIX));

  if (isAdmin) return supplierSheets;

  const headers = user.headers; // normalized uppercase
  const row = user.row;

  return supplierSheets.filter(sheetName => {
    const upper = sheetName.toUpperCase();
    const base = baseSupplierName_(sheetName).toUpperCase(); // strip _YYYY

    // 1) Exact column match first
    let col = headers.indexOf(upper);
    if (col >= 0) {
      const val = safeText_(row[col]).trim().toUpperCase();
      return val === "YES";
    }

    // 2) Fallback to base name column
    col = headers.indexOf(base);
    if (col >= 0) {
      const val = safeText_(row[col]).trim().toUpperCase();
      return val === "YES";
    }

    return false;
  });
}

/** =========================
 *  OUTPUT
 *  ========================= */
function output_(obj, callback) {
  const payload = JSON.stringify(obj);

  if (callback) {
    return ContentService
      .createTextOutput(`${callback}(${payload});`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  return ContentService
    .createTextOutput(payload)
    .setMimeType(ContentService.MimeType.JSON);
}

/** =========================
 *  HELPERS
 *  ========================= */
function normalizeHeaders_(headerRow) {
  return headerRow.map(h => safeText_(h).trim().toUpperCase());
}

function headerIndex_(headers, needed) {
  const idx = {};
  Object.keys(needed).forEach(k => {
    const i = headers.indexOf(String(needed[k]).toUpperCase());
    if (i === -1) throw new Error(`Missing header "${needed[k]}" in supplier sheet`);
    idx[k] = i;
  });
  return idx;
}

function safeText_(v) {
  if (v === null || v === undefined) return "";
  return String(v);
}

function extractYearFromSheetName_(sheetName) {
  const m = String(sheetName).match(/_(\d{4})$/);
  return m ? Number(m[1]) : 0;
}

function baseSupplierName_(sheetName) {
  // Supplier_Severne_2025 -> Supplier_Severne
  return String(sheetName).replace(/_(\d{4})$/, "");
}
