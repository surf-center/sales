<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Sales</title>

  <!-- Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --border:#e5e7eb;
      --muted:#6b7280;
      --bg:#fff;
      --soft:#f9fafb;
      --accent:#111827;
      --ok:#0f7b2f;
      --bad:#b00020;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Poppins',system-ui,sans-serif;
      font-weight:300;
      background:#fcfcfc;
      color:#111;
    }

    #loginView{ display:block; }
    #appView{ display:none; }

    .centerWrap{ max-width:560px; margin:0 auto; padding:32px 16px; text-align:center; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 16px 120px; }

    .logo{ max-height:60px; margin:14px auto; display:block; }

    .btn{
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:500;
    }
    .btnPrimary{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .btnCalc{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:700;
      cursor:pointer;
    }

    .input{
      width:100%;
      padding:13px 14px;
      border-radius:16px;
      border:1px solid var(--border);
      font-size:16px;
    }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:20px;
      padding:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:14px;
    }
    th,td{
      padding:10px;
      border-bottom:1px solid #eee;
      text-align:left;
    }
    th{ font-weight:500; }

    .tdActions{
      text-align:right;
      white-space:nowrap;
    }
    .actionWrap{
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .overlay.active{ display:flex; }

    .modal{
      background:#fff;
      width:min(1100px,96vw);
      height:min(760px,92vh);
      border-radius:20px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modalHeader{
      padding:12px 14px;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:500;
    }
    .modalBody{
      flex:1;
      padding:0;
      overflow:hidden;
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div id="loginView" class="centerWrap">
  <img src="./logo.png" class="logo" onerror="this.style.display='none'">
  <input id="loginKey" class="input" placeholder="Key">
  <div style="margin-top:12px">
    <button id="loginBtn" class="btn btnPrimary" style="width:100%">Login</button>
  </div>
  <div id="loginErr" style="color:var(--bad); margin-top:10px"></div>
</div>

<!-- APP -->
<div id="appView" class="wrap">
  <img src="./logo.png" class="logo" onerror="this.style.display='none'">

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Retail price</th>
          <th>Purchase price</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="4">Laden…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- CALCULATOR MODAL -->
<div id="calcOverlay" class="overlay">
  <div class="modal">
    <div class="modalHeader">
      <span>Calculator</span>
      <button id="calcClose" class="btn">Sluiten</button>
    </div>
    <div class="modalBody">
      <iframe
        id="calcFrame"
        src="about:blank"
        style="width:100%;height:100%;border:0"
      ></iframe>
    </div>
  </div>
</div>

<script>
  const APPS_SCRIPT_WEBAPP_URL =
    "https://script.google.com/macros/s/AKfycbzlOHAETsCoiG3h4rE0ot9RF2Pvp3pr__iyzdbb2Kg5-Dm84B0jEqQKOJ7P7CNUa0s/exec";

  const CALCULATOR_URL = "https://surf-center.github.io/calculator/";

  function jsonp(url){
    return new Promise((resolve,reject)=>{
      const s=document.createElement("script");
      const cb="cb_"+Math.random().toString(36).slice(2);
      window[cb]=d=>{ delete window[cb]; s.remove(); resolve(d); };
      s.onerror=()=>reject();
      s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
      document.body.appendChild(s);
    });
  }

  const loginView = document.getElementById("loginView");
  const appView = document.getElementById("appView");
  const loginBtn = document.getElementById("loginBtn");
  const loginKey = document.getElementById("loginKey");
  const loginErr = document.getElementById("loginErr");
  const tbody = document.getElementById("tbody");

  const calcOverlay = document.getElementById("calcOverlay");
  const calcFrame = document.getElementById("calcFrame");
  const calcClose = document.getElementById("calcClose");

  function openCalculator(row){
    const retail = Number(String(row.retailPrice).replace(",","."));
    const purchase = Number(String(row.purchasePrice).replace(",","."));

    const qs = new URLSearchParams();
    if(Number.isFinite(purchase)) qs.set("p", purchase.toFixed(2)); // Purchase excl
    if(Number.isFinite(retail))   qs.set("s", retail.toFixed(2));   // Selling incl

    calcFrame.src = `${CALCULATOR_URL}?${qs.toString()}`;
    calcOverlay.classList.add("active");
  }

  calcClose.onclick = () => {
    calcOverlay.classList.remove("active");
    calcFrame.src = "about:blank";
  };
  calcOverlay.onclick = e => { if(e.target===calcOverlay) calcClose.onclick(); };

  async function loadData(key){
    const res = await jsonp(`${APPS_SCRIPT_WEBAPP_URL}?action=data&key=${encodeURIComponent(key)}`);
    if(!res || !res.ok) throw new Error(res?.error || "Fout");

    tbody.innerHTML = res.rows.map(r => `
      <tr>
        <td>${r.product||""}</td>
        <td>€ ${r.retailPrice||""}</td>
        <td>€ ${r.purchasePrice||""}</td>
        <td class="tdActions">
          <div class="actionWrap">
            <button class="btnCalc">%</button>
          </div>
        </td>
      </tr>
    `).join("");

    [...tbody.querySelectorAll(".btnCalc")].forEach((b,i)=>{
      b.onclick = () => openCalculator(res.rows[i]);
    });
  }

  loginBtn.onclick = async () => {
    loginErr.textContent = "";
    try{
      await loadData(loginKey.value.trim());
      loginView.style.display="none";
      appView.style.display="block";
    }catch(e){
      loginErr.textContent = "Login mislukt";
    }
  };
</script>
</body>
</html>
