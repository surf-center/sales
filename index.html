<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .hidden { display: none !important; }
    .wrap { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .row > * { flex: 1 1 220px; }
    label { display: block; font-size: 12px; opacity: 0.8; margin-bottom: 6px; }
    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font: inherit;
      box-sizing: border-box;
    }
    button { cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #fafafa; font-weight: 600; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; }
    .msg-ok { border-color: #bfe9c4; background: #f1fff3; }
    .msg-err { border-color: #f2c2c2; background: #fff3f3; }
    .muted { opacity: 0.75; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 6px;">Dashboard</h1>
      <div class="muted">Public view is altijd zichtbaar. Admin view alleen als je admin bent.</div>
    </div>

    <!-- Public view -->
    <div id="publicView" class="card">
      <h2 style="margin-top:0;">Public view</h2>
      <p>Deze content ziet iedereen.</p>
    </div>

    <!-- Auth loading -->
    <div id="authLoading" class="card">
      <strong>Even laden…</strong>
      <div class="muted">We checken je rechten.</div>
    </div>

    <!-- No access -->
    <div id="noAccess" class="card hidden" aria-hidden="true">
      <h2 style="margin-top:0;">Geen toegang</h2>
      <p>Je hebt geen adminrechten om de admin/leads te bekijken.</p>
    </div>

    <!-- Admin view (default hidden: voorkomt “flash”) -->
    <div id="adminView" class="card hidden" aria-hidden="true">
      <h2 style="margin-top:0;">Admin view</h2>

      <!-- Create lead -->
      <div class="card">
        <h3 style="margin-top:0;">Nieuwe lead</h3>

        <form id="leadForm">
          <div class="row">
            <div>
              <label for="leadName">Naam</label>
              <input id="leadName" name="name" autocomplete="name" required />
            </div>

            <div>
              <label for="leadEmail">Email</label>
              <input id="leadEmail" name="email" type="email" autocomplete="email" required />
            </div>

            <div>
              <label for="leadStatus">Status</label>
              <select id="leadStatus" name="status">
                <option value="new">new</option>
                <option value="contacted">contacted</option>
                <option value="qualified">qualified</option>
                <option value="won">won</option>
                <option value="lost">lost</option>
              </select>
            </div>
          </div>

          <div style="margin-top:12px;" class="row">
            <div style="flex: 2 1 320px;">
              <label for="leadNote">Opmerking</label>
              <textarea id="leadNote" name="note" rows="2" placeholder="Optioneel…"></textarea>
            </div>
            <div style="align-self:end; flex: 1 1 160px;">
              <button id="saveLeadBtn" type="submit">Opslaan lead</button>
            </div>
          </div>

          <div id="saveMsg" class="card hidden" aria-hidden="true" style="margin-top:12px;"></div>
        </form>
      </div>

      <!-- Leads list -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
          <h3 style="margin:0;">Leads</h3>
          <button id="refreshBtn" type="button" style="max-width:180px;">Verversen</button>
        </div>

        <div id="leadsLoading" class="card" style="margin-top:12px;">Leads laden…</div>
        <div id="leadsError" class="card hidden msg-err" aria-hidden="true" style="margin-top:12px;"></div>

        <div id="leadsTableWrap" class="hidden" aria-hidden="true" style="margin-top:12px;">
          <table>
            <thead>
              <tr>
                <th>Naam</th>
                <th>Email</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="leadsTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    /**
     * ✅ Pas dit aan als jullie endpoints anders zijn.
     * - ME_ENDPOINT: moet role/isAdmin teruggeven
     * - LEADS_ENDPOINT: GET -> lijst leads (admin-only)
     * - LEADS_CREATE_ENDPOINT: POST -> nieuwe lead maken (admin-only)
     */
    const ME_ENDPOINT = "/api/me";
    const LEADS_ENDPOINT = "/api/leads";
    const LEADS_CREATE_ENDPOINT = "/api/leads"; // vaak zelfde endpoint, POST maakt nieuwe lead

    const el = (id) => document.getElementById(id);

    function show(node) {
      node.classList.remove("hidden");
      node.setAttribute("aria-hidden", "false");
    }
    function hide(node) {
      node.classList.add("hidden");
      node.setAttribute("aria-hidden", "true");
    }

    async function fetchJSON(url, options = {}) {
      const res = await fetch(url, {
        credentials: "include",
        headers: { "Content-Type": "application/json", ...(options.headers || {}) },
        ...options,
      });

      // Probeer JSON te lezen, maar val terug op tekst
      const contentType = res.headers.get("content-type") || "";
      const body = contentType.includes("application/json")
        ? await res.json().catch(() => null)
        : await res.text().catch(() => "");

      if (!res.ok) {
        const msg =
          (body && typeof body === "object" && (body.message || body.error)) ||
          (typeof body === "string" && body) ||
          `${res.status} ${res.statusText}`;
        const err = new Error(msg);
        err.status = res.status;
        err.body = body;
        throw err;
      }
      return body;
    }

    function isAdminFromMe(me) {
      // Flexibel: support {role:"admin"} of {isAdmin:true}
      if (!me) return false;
      if (me.isAdmin === true) return true;
      if (typeof me.role === "string" && me.role.toLowerCase() === "admin") return true;
      if (Array.isArray(me.roles) && me.roles.map(r => String(r).toLowerCase()).includes("admin")) return true;
      return false;
    }

    async function init() {
      // Default states: adminView hidden in HTML => geen flash mogelijk
      show(el("authLoading"));
      hide(el("adminView"));
      hide(el("noAccess"));

      let me;
      try {
        me = await fetchJSON(ME_ENDPOINT, { method: "GET" });
      } catch (err) {
        // Als /api/me faalt, behandel als geen toegang
        hide(el("authLoading"));
        show(el("noAccess"));
        return;
      }

      hide(el("authLoading"));

      if (!isAdminFromMe(me)) {
        show(el("noAccess"));
        return;
      }

      // Admin confirmed => nu pas admin view zichtbaar
      show(el("adminView"));

      // Bind events
      el("refreshBtn").addEventListener("click", () => loadLeads());
      el("leadForm").addEventListener("submit", onSubmitLead);

      // Initial load
      await loadLeads();
    }

    async function loadLeads() {
      show(el("leadsLoading"));
      hide(el("leadsError"));
      hide(el("leadsTableWrap"));

      try {
        const leads = await fetchJSON(LEADS_ENDPOINT, { method: "GET" });

        const tbody = el("leadsTbody");
        tbody.innerHTML = "";

        // Accept zowel {data:[...]} als [...]
        const items = Array.isArray(leads) ? leads : (leads && leads.data) ? leads.data : [];

        for (const lead of items) {
          const tr = document.createElement("tr");

          const name = document.createElement("td");
          name.textContent = lead.name ?? "-";

          const email = document.createElement("td");
          email.textContent = lead.email ?? "-";

          const status = document.createElement("td");
          const pill = document.createElement("span");
          pill.className = "pill";
          pill.textContent = lead.status ?? "-";
          status.appendChild(pill);

          tr.appendChild(name);
          tr.appendChild(email);
          tr.appendChild(status);

          tbody.appendChild(tr);
        }

        hide(el("leadsLoading"));
        show(el("leadsTableWrap"));
      } catch (err) {
        hide(el("leadsLoading"));
        const box = el("leadsError");
        box.textContent = `Leads konden niet geladen worden: ${err.message}`;
        show(box);
      }
    }

    async function onSubmitLead(e) {
      e.preventDefault();

      const btn = el("saveLeadBtn");
      btn.disabled = true;

      const msg = el("saveMsg");
      hide(msg);
      msg.classList.remove("msg-ok", "msg-err");

      const payload = {
        name: el("leadName").value.trim(),
        email: el("leadEmail").value.trim(),
        status: el("leadStatus").value,
        note: el("leadNote").value.trim() || null,
      };

      // Basic validation
      if (!payload.name || !payload.email) {
        msg.textContent = "Naam en email zijn verplicht.";
        msg.classList.add("msg-err");
        show(msg);
        btn.disabled = false;
        return;
      }

      try {
        /**
         * ✅ Belangrijk: GEEN "action: submitLead" meer.
         * Dit voorkomt: "Unknown action: submitLead"
         */
        await fetchJSON(LEADS_CREATE_ENDPOINT, {
          method: "POST",
          body: JSON.stringify(payload),
        });

        msg.textContent = "Lead opgeslagen ✅";
        msg.classList.add("msg-ok");
        show(msg);

        // Form reset
        el("leadForm").reset();
        // Keep a nice default status if you want:
        el("leadStatus").value = "new";

        // Refresh list
        await loadLeads();
      } catch (err) {
        msg.textContent = `Fout bij opslaan: ${err.message}`;
        msg.classList.add("msg-err");
        show(msg);
      } finally {
        btn.disabled = false;
      }
    }

    init();
  </script>
</body>
</html>
