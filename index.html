<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

  <style>
    :root{ --border:#e5e7eb; --muted:#6b7280; --bg:#fff; --soft:#f9fafb; --accent:#111827; --ok:#0f7b2f; --bad:#b00020; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'Poppins',system-ui,sans-serif; font-weight:300; background:#fcfcfc; color:#111; }

    #loginView{ display:block; }
    #appView{ display:none; }

    .centerWrap{ max-width:560px; margin:0 auto; padding:34px 18px 28px; text-align:center; }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px 18px 96px; }
    @media (max-width:480px){ .centerWrap{ padding:26px 16px 20px; } .wrap{ padding:12px 16px 96px; } }

    .logo{ display:block; width:min(560px,100%); height:auto; max-height:72px; object-fit:contain; margin:18px auto 18px; }
    @media (max-width:480px){ .logo{ max-height:58px; margin:14px auto 14px; } }

    .btn{ font-family:'Poppins',sans-serif; font-weight:500; padding:10px 14px; border-radius:14px; border:1px solid var(--border); background:#fff; cursor:pointer; white-space:nowrap; }
    .btn:hover{ background:#f3f4f6; }
    .btnPrimary{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .btnPrimary:hover{ opacity:.92; background:var(--accent); }

    .input{ width:100%; padding:13px 14px; border-radius:16px; border:1px solid var(--border); font-family:'Poppins',sans-serif; font-weight:500; font-size:15px; background:#fff; }
    .muted{ color:var(--muted); font-size:13px; font-weight:300; }
    .err{ color:var(--bad); font-size:13px; margin-top:10px; text-align:left; }

    .loginCard{ background:var(--bg); border:1px solid var(--border); border-radius:20px; padding:16px; text-align:left; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:6px 0 12px; }

    .searchWrap{ display:flex; justify-content:center; margin:6px 0 14px; }
    .searchWrap input{ width:min(560px,100%); }

    .card{ background:var(--bg); border:1px solid var(--border); border-radius:20px; padding:12px; }
    .tableWrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:820px; }
    th{ padding:10px; border-bottom:1px solid #eee; font-weight:500; text-align:left; white-space:nowrap; }
    td{ padding:10px; border-bottom:1px solid #f1f1f1; font-weight:300; vertical-align:top; }
    .detailsRow td{ background:var(--soft); border-bottom:1px solid #eaeaea; }
    .small{ font-size:12px; color:var(--muted); }

    .detailsGrid{ display:grid; grid-template-columns:1fr; gap:6px; padding:2px 0; }
    .detailsLine{ display:flex; gap:10px; align-items:baseline; }
    .detailsKey{ min-width:110px; font-weight:500; }
    @media (max-width:480px){ .detailsKey{ min-width:92px; } }

    .calcFab{ position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 10px 25px rgba(0,0,0,.25); z-index:9999; user-select:none; }
    .calcFab span{ font-weight:700; font-size:22px; transform:translateY(-1px); }

    .cartFab{ position:fixed; left:18px; bottom:18px; height:56px; padding:0 16px; border-radius:999px; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; gap:10px; cursor:pointer; box-shadow:0 10px 25px rgba(0,0,0,.25); z-index:9999; user-select:none; font-family:'Poppins',sans-serif; font-weight:700; }
    .cartFab .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:30px; height:30px; padding:0 9px; border-radius:999px; background:#fff; color:#111; font-weight:700; font-size:13px; }
    @media (max-width:480px){ .cartFab{ left:14px; bottom:14px; height:54px; padding:0 14px; } .calcFab{ right:14px; bottom:14px; width:54px; height:54px; } }

    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:10000; padding:14px; }
    .overlay.active{ display:flex; }
    .modal{ background:#fff; width:min(1100px,96vw); height:min(760px,92vh); border-radius:20px; overflow:hidden; display:flex; flex-direction:column; }
    .modalHeader{ padding:12px 14px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; font-weight:500; gap:10px; }
    .modalHeader .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .modalBody{ padding:14px; overflow:auto; }
    .modal iframe{ flex:1; border:0; width:100%; }

    .formGrid{ display:grid; grid-template-columns:1fr; gap:12px; }
    .field label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px; font-weight:500; }
    .field input, .field textarea{ width:100%; padding:11px 12px; border-radius:14px; border:1px solid var(--border); font-family:'Poppins',sans-serif; font-weight:500; font-size:14px; background:#fff; }
    .field textarea{ min-height:86px; resize:vertical; font-weight:300; }

    .cartList{ margin:10px 0 0; border:1px solid var(--border); border-radius:16px; overflow:hidden; }
    .cartRow{ display:flex; justify-content:space-between; gap:10px; padding:12px 12px; border-bottom:1px solid #eee; }
    .cartRow:last-child{ border-bottom:none; }
    .cartRow .left{ display:flex; flex-direction:column; gap:3px; }

    .tick{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid rgba(15,123,47,.25); background:rgba(15,123,47,.06); border-radius:14px; color:var(--ok); font-weight:500; margin-top:12px; }
    .tick .dot{ width:22px; height:22px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:var(--ok); color:#fff; font-weight:700; }
  </style>
</head>

<body>
  <!-- LOGIN -->
  <div id="loginView" class="centerWrap">
    <img src="./logo.png" alt="Logo" class="logo" onerror="this.style.display='none';">
    <div class="loginCard">
      <div style="font-weight:700; margin-bottom:10px;">Inloggen</div>
      <input id="loginKey" class="input" placeholder="Key" autocomplete="off" autocapitalize="off" spellcheck="false">
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button id="loginBtn" class="btn btnPrimary" style="flex:1;">Login</button>
      </div>
      <div id="loginErr" class="err"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="wrap">
    <div class="topbar">
      <div></div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="accountBtn" class="btn">Account</button>
        <button id="logoutBtn" class="btn">Log uit</button>
      </div>
    </div>

    <img src="./logo.png" alt="Logo" class="logo" onerror="this.style.display='none';">

    <div class="searchWrap">
      <input id="searchInput" class="input" placeholder="Zoek product of EAN…" disabled>
    </div>

    <div id="meta" class="muted" style="min-height:18px; margin:0 0 12px;"></div>
    <div id="err" class="err"></div>

    <div class="card">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Product</th>
              <th>Retail price</th>
              <th>Surfcenter</th>
              <th>Dropshipment</th>
              <th>Add</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" class="small">Laden…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Floating CART -->
  <div class="cartFab" id="cartBtn" style="display:none;">
    <span>Cart</span><span class="badge" id="cartBadge">0</span>
  </div>

  <!-- Floating CALC -->
  <div class="calcFab" id="calcBtn" style="display:none;">
    <span>%</span>
  </div>

  <!-- Calculator modal -->
  <div id="calcOverlay" class="overlay">
    <div class="modal">
      <div class="modalHeader">
        <span>Marge calculator</span>
        <div class="actions">
          <button id="calcOpenNew" class="btn">Nieuw tab</button>
          <button id="calcClose" class="btn">Sluiten</button>
        </div>
      </div>
      <iframe src="https://surf-center.github.io/calculator/" title="Calculator"></iframe>
    </div>
  </div>

  <!-- Cart / Lead modal -->
  <div id="cartOverlay" class="overlay">
    <div class="modal">
      <div class="modalHeader">
        <span>Lead doorgeven</span>
        <div class="actions">
          <button id="cartClose" class="btn">Sluiten</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="formGrid">
          <div class="field">
            <label>Name *</label>
            <input id="custName" placeholder="Name">
          </div>

          <!-- ✅ SWAPPED: Phone number first -->
          <div class="field">
            <label>Phone number *</label>
            <input id="phone" placeholder="Phone number">
          </div>

          <!-- ✅ SWAPPED: Mail second -->
          <div class="field">
            <label>Mail (optioneel)</label>
            <input id="mail" placeholder="Mail">
          </div>

          <div class="field">
            <label>Note 1 (optioneel)</label>
            <textarea id="note1" placeholder="Note"></textarea>
          </div>
          <div class="field">
            <label>Note 2 (optioneel)</label>
            <textarea id="note2" placeholder="Note"></textarea>
          </div>
        </div>

        <div style="margin-top:14px; font-weight:700;">Items:</div>
        <div id="cartList" class="cartList"></div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:14px; flex-wrap:wrap;">
          <button id="clearCartBtn" class="btn">Leegmaken</button>
          <button id="saveLeadBtn" class="btn btnPrimary">Opslaan</button>
        </div>

        <div id="cartErr" class="err"></div>
        <div id="cartTick" class="tick" style="display:none;">
          <span class="dot">✓</span><span>Lead opgeslagen</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Account modal -->
  <div id="accountOverlay" class="overlay">
    <div class="modal">
      <div class="modalHeader">
        <span id="accountTitle">Account</span>
        <div class="actions">
          <button id="accountClose" class="btn">Sluiten</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="muted" id="accountSub" style="margin-bottom:10px;"></div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
            <div style="font-weight:700;">Leads overzicht</div>
            <button id="accountRefresh" class="btn">Refresh</button>
          </div>

          <div class="tableWrap" style="margin-top:8px;">
            <table style="min-width:980px;">
              <thead>
                <tr>
                  <th>Product</th><th>Retail price</th>
                  <th>Name</th><th>Phone number</th><th>Mail</th>
                  <th>Note 1</th><th>Note 2</th>
                  <th>Sale</th>
                </tr>
              </thead>
              <tbody id="accountOrdersTbody">
                <tr><td colspan="8" class="small">Laden…</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div id="accountErr" class="err"></div>
      </div>
    </div>
  </div>

  <script>
    const APPS_SCRIPT_WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbwpnwNyO2micTXDswc10-gRenPh51riMYojlYhAE1FGN7LizthfF0CNy0cLkV11AdmENg/exec";

    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        const cb="cb_"+Math.random().toString(36).slice(2);
        const t=setTimeout(()=>{cleanup();reject(new Error("Timeout"));},15000);
        window[cb]=d=>{cleanup();resolve(d);};
        function cleanup(){clearTimeout(t);delete window[cb];s.remove();}
        s.onerror=()=>{cleanup();reject(new Error("Failed to load script"));};
        s.src=url+(url.includes("?")?"&":"?")+"callback="+cb;
        document.body.appendChild(s);
      });
    }

    function fmtPrice(v){
      if(v===null||v===undefined||v==="") return "";
      const n = Number(String(v).replace(",","."));
      return Number.isFinite(n) ? "€ " + n.toFixed(2) : String(v);
    }
    const fmtVal = v => (v==null?"":String(v));
    const esc = s => String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));

    function matchesTokens(row, q){
      const tokens = q.split(/\s+/).filter(Boolean);
      if(!tokens.length) return true;
      const hay = ((row.product||"") + " " + (row.ean||"")).toLowerCase();
      return tokens.every(t => hay.includes(t));
    }

    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const loginKey = document.getElementById("loginKey");
    const loginBtn = document.getElementById("loginBtn");
    const loginErr = document.getElementById("loginErr");

    const accountBtn = document.getElementById("accountBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const searchInput = document.getElementById("searchInput");
    const tbody = document.getElementById("tbody");
    const meta = document.getElementById("meta");
    const err = document.getElementById("err");

    const cartBtn = document.getElementById("cartBtn");
    const calcBtn = document.getElementById("calcBtn");

    const calcOverlay = document.getElementById("calcOverlay");
    document.getElementById("calcBtn").onclick = () => calcOverlay.classList.add("active");
    document.getElementById("calcClose").onclick = () => calcOverlay.classList.remove("active");
    document.getElementById("calcOpenNew").onclick = () => window.open("https://surf-center.github.io/calculator/","_blank","noopener");
    calcOverlay.addEventListener("click", e => { if(e.target===calcOverlay) calcOverlay.classList.remove("active"); });

    const cartOverlay = document.getElementById("cartOverlay");
    const cartClose = document.getElementById("cartClose");
    const cartListEl = document.getElementById("cartList");
    const cartErr = document.getElementById("cartErr");
    const cartTick = document.getElementById("cartTick");
    const clearCartBtn = document.getElementById("clearCartBtn");
    const saveLeadBtn = document.getElementById("saveLeadBtn");

    const custName = document.getElementById("custName");
    const phone = document.getElementById("phone");   // ✅ contact 1
    const mail = document.getElementById("mail");     // ✅ contact 2
    const note1 = document.getElementById("note1");
    const note2 = document.getElementById("note2");

    const accountOverlay = document.getElementById("accountOverlay");
    const accountClose = document.getElementById("accountClose");
    const accountRefresh = document.getElementById("accountRefresh");
    const accountTitle = document.getElementById("accountTitle");
    const accountSub = document.getElementById("accountSub");
    const accountOrdersTbody = document.getElementById("accountOrdersTbody");
    const accountErr = document.getElementById("accountErr");

    let currentKey = "";
    let currentUserName = "";
    let isAdmin = false;

    let allRows = [];
    let expanded = new Set();
    let cart = [];

    function setCartBadge(){ document.getElementById("cartBadge").textContent = String(cart.length); }

    function showLogin(){
      loginView.style.display = "block";
      appView.style.display = "none";
      cartBtn.style.display = "none";
      calcBtn.style.display = "none";
      loginErr.textContent = "";
      loginKey.value = "";
      loginKey.focus();
    }
    function showApp(){
      loginView.style.display = "none";
      appView.style.display = "block";
      cartBtn.style.display = "";
      calcBtn.style.display = "";
    }
    function logout(){
      localStorage.removeItem("employeeKey");
      currentKey = "";
      showLogin();
    }
    logoutBtn.onclick = logout;

    function openCart(){
      cartErr.textContent = "";
      cartTick.style.display = "none";
      renderCart();
      cartOverlay.classList.add("active");
    }
    function closeCart(){ cartOverlay.classList.remove("active"); }
    cartBtn.onclick = openCart;
    cartClose.onclick = closeCart;
    cartOverlay.addEventListener("click", e => { if(e.target===cartOverlay) closeCart(); });

    clearCartBtn.onclick = () => { cart=[]; setCartBadge(); renderCart(); };

    function addToCart(item){
      if(cart.some(x => x.ean === item.ean)) return;
      cart.push({ ean:item.ean, product:item.product, retailPrice:item.retailPrice });
      setCartBadge();
    }
    function removeFromCart(ean){
      cart = cart.filter(x => x.ean !== ean);
      setCartBadge();
      renderCart();
    }
    function renderCart(){
      if(!cart.length){
        cartListEl.innerHTML = `<div class="cartRow"><div class="small">Geen items.</div></div>`;
        return;
      }
      cartListEl.innerHTML = cart.map(it => `
        <div class="cartRow">
          <div class="left">
            <div style="font-weight:500;">${esc(it.product || "")}</div>
            <div class="small">Retail: ${esc(fmtPrice(it.retailPrice))}</div>
          </div>
          <div><button class="btn" data-remove="${esc(it.ean)}">Verwijder</button></div>
        </div>
      `).join("");
      cartListEl.querySelectorAll("button[data-remove]").forEach(b=>{
        b.addEventListener("click", ()=> removeFromCart(b.getAttribute("data-remove")));
      });
    }

    function openAccount(){
      accountErr.textContent = "";
      accountOverlay.classList.add("active");
      accountTitle.textContent = currentUserName ? currentUserName : "Account";
      accountSub.textContent = isAdmin ? "Admin view: alle leads" : "Jouw leads";
      loadAccountOrders();
    }
    function closeAccount(){ accountOverlay.classList.remove("active"); }
    accountBtn.onclick = openAccount;
    accountClose.onclick = closeAccount;
    accountOverlay.addEventListener("click", e => { if(e.target===accountOverlay) closeAccount(); });
    accountRefresh.onclick = loadAccountOrders;

    async function loadAccountOrders(){
      accountOrdersTbody.innerHTML = `<tr><td colspan="8" class="small">Laden…</td></tr>`;
      const scope = isAdmin ? "all" : "mine";
      try{
        const res = await jsonp(`${APPS_SCRIPT_WEBAPP_URL}?action=orders&scope=${scope}&key=${encodeURIComponent(currentKey)}`);
        if(!res || !res.ok) throw new Error(res?.error || "Kon leads niet laden");
        const orders = Array.isArray(res.orders) ? res.orders : [];

        if(!orders.length){
          accountOrdersTbody.innerHTML = `<tr><td colspan="8" class="small">Geen leads.</td></tr>`;
          return;
        }

        accountOrdersTbody.innerHTML = orders.map(o => `
          <tr>
            <td>${esc(o.product||"")}</td>
            <td>${esc(fmtPrice(o.retailPrice))}</td>
            <td>${esc(o.name||"")}</td>
            <td>${esc(o.phoneNumber||"")}</td>
            <td>${esc(o.mail||"")}</td>
            <td>${esc(o.note1||"")}</td>
            <td>${esc(o.note2||"")}</td>
            <td>${esc(o.sale||"")}</td>
          </tr>
        `).join("");
      }catch(e){
        accountErr.textContent = e.message;
        accountOrdersTbody.innerHTML = `<tr><td colspan="8" class="small">Fout.</td></tr>`;
      }
    }

    async function loadProducts(){
      err.textContent = "";
      meta.textContent = "Laden…";
      tbody.innerHTML = `<tr><td colspan="6" class="small">Data laden…</td></tr>`;

      const res = await jsonp(`${APPS_SCRIPT_WEBAPP_URL}?action=data&key=${encodeURIComponent(currentKey)}`);
      if(!res || !res.ok) throw new Error(res?.error || "Kon data niet laden");

      isAdmin = !!res.isAdmin;
      currentUserName = (res.user && res.user.name) ? res.user.name : "";
      accountBtn.textContent = currentUserName ? currentUserName : "Account";

      allRows = Array.isArray(res.rows) ? res.rows : [];
      expanded.clear();

      meta.textContent = `${allRows.length} items`;
      searchInput.disabled = false;
      renderProducts();
    }

    function renderProducts(){
      const q = searchInput.value.trim().toLowerCase();
      const rows = !q ? allRows : allRows.filter(r => matchesTokens(r, q));

      tbody.innerHTML = "";
      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="6" class="small">Geen resultaten.</td></tr>`;
        return;
      }

      rows.forEach((r,i)=>{
        const id = `${r.ean}__${i}`;
        const tr = document.createElement("tr");

        const tdExpand = document.createElement("td");
        const b = document.createElement("button");
        b.className = "btn";
        b.style.padding = "7px 10px";
        b.textContent = expanded.has(id) ? "−" : "+";
        b.onclick = () => { expanded.has(id) ? expanded.delete(id) : expanded.add(id); renderProducts(); };
        tdExpand.appendChild(b);

        tr.appendChild(tdExpand);
        tr.appendChild(Object.assign(document.createElement("td"), { textContent: r.product || "" }));
        tr.appendChild(Object.assign(document.createElement("td"), { textContent: fmtPrice(r.retailPrice) }));
        tr.appendChild(Object.assign(document.createElement("td"), { textContent: fmtVal(r.surfcenterStock) }));
        tr.appendChild(Object.assign(document.createElement("td"), { textContent: fmtVal(r.dropshipmentStock) }));

        const tdAdd = document.createElement("td");
        const addBtn = document.createElement("button");
        addBtn.className = "btn btnPrimary";
        addBtn.textContent = "Add";
        addBtn.onclick = () => addToCart({ ean:r.ean, product:r.product, retailPrice:r.retailPrice });
        tdAdd.appendChild(addBtn);
        tr.appendChild(tdAdd);

        tbody.appendChild(tr);

        if(expanded.has(id)){
          const tr2 = document.createElement("tr");
          tr2.className = "detailsRow";
          const td = document.createElement("td");
          td.colSpan = 6;
          td.innerHTML = `
            <div class="detailsGrid">
              <div class="detailsLine"><span class="detailsKey">Season:</span><span>${esc(r.season||"")}</span></div>
              <div class="detailsLine"><span class="detailsKey">EAN:</span><span>${esc(r.ean||"")}</span></div>
              <div class="detailsLine"><span class="detailsKey">Purchase price:</span><span>${esc(fmtPrice(r.purchasePrice))}</span></div>
            </div>
          `;
          tr2.appendChild(td);
          tbody.appendChild(tr2);
        }
      });
    }
    searchInput.addEventListener("input", renderProducts);

    // ✅ submitLead payload now matches swapped fields
    saveLeadBtn.onclick = async () => {
      cartErr.textContent = "";
      cartTick.style.display = "none";

      const name = custName.value.trim();
      const p = phone.value.trim(); // contact 1
      const m = mail.value.trim();  // contact 2
      const n1 = note1.value.trim();
      const n2 = note2.value.trim();

      if(!name){ cartErr.textContent = "Name is verplicht."; return; }
      if(!p && !m){ cartErr.textContent = "Minimaal Phone number of Mail is verplicht."; return; }
      if(!cart.length){ cartErr.textContent = "Cart is leeg."; return; }

      const payload = { name, phoneNumber:p, mail:m, note1:n1, note2:n2, items:cart };
      const url = `${APPS_SCRIPT_WEBAPP_URL}?action=submitLead&key=${encodeURIComponent(currentKey)}&payload=${encodeURIComponent(JSON.stringify(payload))}`;

      saveLeadBtn.disabled = true;
      saveLeadBtn.textContent = "Opslaan…";
      try{
        const res = await jsonp(url);
        if(!res || !res.ok) throw new Error(res?.error || "Opslaan mislukt");

        cart = [];
        setCartBadge();
        renderCart();

        custName.value=""; phone.value=""; mail.value=""; note1.value=""; note2.value="";
        cartTick.style.display = "";
      }catch(e){
        cartErr.textContent = "Fout bij opslaan: " + e.message;
      }finally{
        saveLeadBtn.disabled = false;
        saveLeadBtn.textContent = "Opslaan";
      }
    };

    // Login
    loginBtn.onclick = async () => {
      loginErr.textContent = "";
      const key = loginKey.value.trim();
      if(!key){ loginErr.textContent = "Vul een key in."; return; }

      loginBtn.disabled = true;
      loginBtn.textContent = "Login…";
      try{
        const res = await jsonp(`${APPS_SCRIPT_WEBAPP_URL}?action=data&key=${encodeURIComponent(key)}`);
        if(!res || !res.ok) throw new Error(res?.error || "Login mislukt");

        localStorage.setItem("employeeKey", key);
        currentKey = key;

        showApp();
        setCartBadge();

        isAdmin = !!res.isAdmin;
        currentUserName = (res.user && res.user.name) ? res.user.name : "";
        accountBtn.textContent = currentUserName ? currentUserName : "Account";

        allRows = Array.isArray(res.rows) ? res.rows : [];
        expanded.clear();
        meta.textContent = `${allRows.length} items`;
        searchInput.disabled = false;
        renderProducts();

      }catch(e){
        loginErr.textContent = e.message;
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = "Login";
      }
    };

    // init
    document.addEventListener("DOMContentLoaded", () => {
      const stored = (localStorage.getItem("employeeKey") || "").trim();
      if(!stored){ showLogin(); return; }
      currentKey = stored;

      showApp();
      setCartBadge();

      loadProducts().catch(()=>{ logout(); });

      cartBtn.style.display = "";
      calcBtn.style.display = "";
    });
  </script>
</body>
</html>
